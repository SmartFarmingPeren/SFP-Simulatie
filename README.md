# SFP-Simulatie

## Why ROS noetic and Unity
We use Unity because its able to be used for 3D simulations, a robot can be imported with an .urdf file and its able to make a connection with ROS. We use ROS to move the imported robot, the usage of ROS has been suggested by the Action group.


## Requirements
To setup everything there are some requirements to make the simulation usable.
* Virtual box with the SFP-Simulation .vbox 			[Code branch](https://github.com/SmartFarmingPeren/SFP-Simulatie/tree/ROS-Sim)
* Unity 2020.2.0b9 installed.							[Code branch](https://github.com/SmartFarmingPeren/SFP-Simulatie/tree/Unity-Sim)

The virtual machine network should be set up as a bridged adapter.
Unity 2020.2.0b9 is used for compatibility with imported packages for a ROS connection and to import the robot.

## Setup Unity
To setup the unity environment download the git and add the "Boomgaard simulatie" folder in the Unity folder to your Unity projects in [Unity Hub](https://unity3d.com/get-unity/download). Then download the [2020.2.0b9](https://unity3d.com/unity/beta/2020.2.0b9) Unity version. Once you have opened the Unity project open the "ground_test" scene to get the simulation environment.
![afbeelding](https://user-images.githubusercontent.com/62204721/114179190-f86f5500-993e-11eb-9c6c-58e3a2ac3b10.png)


### Bug fix with packages
If the Unity project does not open and you get the following error message there are some actions that need to be done to safely open the Unity project.

![unityGitError](https://user-images.githubusercontent.com/62204721/114179478-54d27480-993f-11eb-87cf-2733367ce5d5.png)

First navigate to ```PATH_TO\SFP-Simulatie\Unity\Boomgaard simulatie\Packages``` and open the manifest.json file with an editor, locate
* com.unity.robotics.ros-tcp-connector
* com.unity.robotics.urdf-importer

and cut them out of the file, for safety paste them in a notepad.
Then open the Unity project in safe mode and open the package manager window.
![package manager unity](https://user-images.githubusercontent.com/62204721/114180783-f6a69100-9940-11eb-8128-0652eb695e6e.png)

In this window import the packages by selecting the "add package from git url..." option.
![giturl](https://user-images.githubusercontent.com/62204721/114181177-77658d00-9941-11eb-99d7-12991b8a13be.png)
and paste the folowing urls in the add bar.
* https://github.com/Unity-Technologies/ROS-TCP-Connector.git?path=/com.unity.robotics.ros-tcp-connector#v0.2.0
* https://github.com/Unity-Technologies/URDF-Importer.git?path=/com.unity.robotics.urdf-importer#v0.2.0

![afbeelding](https://user-images.githubusercontent.com/62204721/114181535-ea6f0380-9941-11eb-8988-365fd54a0441.png)

This should make you exit safe mode and you can open you Unity project.

## Connect to ROS
![afbeelding](https://user-images.githubusercontent.com/62204721/114183048-9d8c2c80-9943-11eb-92ca-5f085d393861.png)

![afbeelding](https://user-images.githubusercontent.com/62204721/114183232-beed1880-9943-11eb-9e33-c5259561da32.png)

Add the "ROS IP Address" in the ROS Connection script of the machine running ros and Play to make the connection. The IP should match the IP of the virtual machine, or computer running the ROS software.
To get the ip you can use the following command in the ROS machine terminal
> hostname -I

![afbeelding](https://user-images.githubusercontent.com/62204721/114183356-e3e18b80-9943-11eb-939c-fd2e4ad26350.png)


## ROS-msgs
For unity to understand the incoming TCP-messages from the ROS TCP-Server you need to compile the ROS-msgs on the unity side into C# classes.
Luckily a tool has been provided for just that. Under the robotics tab the **Generate ROS Messages** option can be used to generate these C# classes.
Select the ROS message folder containing the .msg files. By default these are stored in the *Boomgaard simulatie/ROSmsg* directory.
Afterwards C# classes can be generated by unfolding the folder and building all the messages.


## Plans for the future